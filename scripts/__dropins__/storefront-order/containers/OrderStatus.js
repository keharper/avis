/*! Copyright 2024 Adobe
All Rights Reserved. */
import{jsx as o,Fragment as S,jsxs as N}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as F,classes as y}from"@dropins/tools/lib.js";import{Button as E,InLineAlert as P,Modal as G,Card as V,Header as K}from"@dropins/tools/components.js";import{useState as g,useEffect as $,useCallback as q}from"@dropins/tools/preact-hooks.js";import"../chunks/ShippingStatusCard.js";import{useMemo as H,useState as W}from"@dropins/tools/preact-compat.js";import{u as k}from"../chunks/useGetStoreConfig.js";import"@dropins/tools/preact.js";import{events as v}from"@dropins/tools/event-bus.js";import{G as j}from"../chunks/getGuestOrder.graphql.js";import{f as z,h as B}from"../chunks/fetch-graphql.js";import{b as Q}from"../chunks/transform-customer-orders-returns.js";import{useText as O,Text as b}from"@dropins/tools/i18n.js";import{C as J}from"../chunks/OrderLoaders.js";import{f as X}from"../chunks/returnOrdersHelper.js";import{f as x}from"../chunks/formatDateToLocale.js";import{r as U}from"../chunks/redirectTo.js";import{O as Y}from"../chunks/OrderCancelForm.js";import{r as Z}from"../chunks/reorderItems.js";import"../chunks/getStoreConfig.js";import"@dropins/tools/fetch-graphql.js";import"../chunks/convertCase.js";import"../chunks/getFormValues.js";import"../chunks/requestGuestOrderCancel.js";import"../chunks/network-error.js";var _=(r=>(r.CANCEL="CANCEL",r.RETURN="RETURN",r.REORDER="REORDER",r))(_||{});const D=({className:r,orderData:t,slots:n,routeCreateReturn:e,routeOnSuccess:a,onError:s})=>{const d=O({cancel:"Order.OrderStatusContent.actions.cancel",createReturn:"Order.OrderStatusContent.actions.createReturn",createAnotherReturn:"Order.OrderStatusContent.actions.createAnotherReturn",reorder:"Order.OrderStatusContent.actions.reorder"}),l=H(()=>{const i=t==null?void 0:t.availableActions,c=!!(i!=null&&i.length),m=!!(t!=null&&t.returnNumber),f=()=>{U(e,{},t)};return o(S,{children:n!=null&&n.OrderActions?o(F,{"data-testid":"OrderActionsSlot",name:"OrderCanceledActions",slot:n==null?void 0:n.OrderActions,context:t}):o("div",{"data-testid":"availableActionsList",className:y(["order-order-actions__wrapper",["order-order-actions__wrapper--empty",!c]]),children:i==null?void 0:i.map(p=>{switch(p){case _.CANCEL:return o(S,{children:m?null:o(se,{orderRef:(t==null?void 0:t.token)??(t==null?void 0:t.id)})});case _.RETURN:return o(E,{variant:"secondary",onClick:f,children:m?d.createAnotherReturn:d.createReturn});case _.REORDER:return o(S,{children:m?null:o(oe,{orderData:t,onError:s,routeOnSuccess:a,children:d.reorder})})}})})})},[s,t,a,e,n,d]);return o("div",{className:y(["order-order-actions",r]),children:l})},ee=({orderData:r})=>{const[t,n]=g(r),[e,a]=g(r==null?void 0:r.status);return $(()=>{const s=v.on("order/data",d=>{n(d),a(d.status)},{eager:!0});return()=>{s==null||s.off()}},[]),{orderStatus:e,order:t}},re=`
  mutation CONFIRM_CANCEL_ORDER_MUTATION(
      $orderId: ID!,
      $confirmationKey: String!
    ) {
    confirmCancelOrder(input: {
      order_id: $orderId,
      confirmation_key: $confirmationKey
    }) {
      order {
        ...guestOrderData
      }
      errorV2 {
        message
        code
      }
    }
  }
${j}
`,te=async(r,t)=>z(re,{variables:{orderId:r,confirmationKey:t}}).then(async({errors:n,data:e})=>{var d,l,i,c;const a=[...(d=e==null?void 0:e.confirmCancelOrder)!=null&&d.errorV2?[(l=e==null?void 0:e.confirmCancelOrder)==null?void 0:l.errorV2]:[],...n??[]];let s=null;return(i=e==null?void 0:e.confirmCancelOrder)!=null&&i.order&&(s=Q((c=e==null?void 0:e.confirmCancelOrder)==null?void 0:c.order),v.emit("order/data",s)),a.length>0?B(a):s}),ne=({enableOrderCancellation:r})=>{const t=O({orderCancelled:"Order.OrderStatusContent.orderCanceled.message"}),[n,e]=g({text:"",status:void 0});return $(()=>{if(!r)return;const a=new URLSearchParams(window.location.search),s=a.get("order_id"),d=a.get("confirmation_key");s&&d&&te(s,d).then(()=>{e({text:t.orderCancelled,status:"success"})}).catch(l=>{e({text:l.message,status:"warning"})})},[r,t.orderCancelled]),{confirmOrderCancellation:n}},be=({slots:r,orderData:t,className:n,statusTitle:e,status:a,routeCreateReturn:s,onError:d,routeOnSuccess:l})=>{const{orderStatus:i,order:c}=ee({orderData:t}),[m,f]=W(!1),p=()=>{f(!0);const C=new URL(window.location.href),A=C.searchParams.get("order_id"),T=C.searchParams.get("confirmation_key");A&&T&&(C.searchParams.delete("order_id"),C.searchParams.delete("confirmation_key"),window.history.replaceState({},document.title,C.toString()))},h=O({cancelOrder:"Order.OrderStatusContent.actions.cancel"}),R=k(),{confirmOrderCancellation:u}=ne({enableOrderCancellation:R==null?void 0:R.orderCancellationEnabled});return N("div",{className:y(["order-order-status",n]),children:[!m&&(u==null?void 0:u.status)!==void 0&&o(P,{heading:h.cancelOrder,onDismiss:p,description:u.text,type:u.status}),c?o(ce,{title:e,status:a||i,slots:r,orderData:c,routeCreateReturn:s,onError:d,routeOnSuccess:l}):o(J,{withCard:!1})]})},se=({orderRef:r})=>{const[t,n]=g(!1),e=()=>{n(!0)},a=()=>{n(!1)},s=k(),d=(s==null?void 0:s.orderCancellationReasons)??[],l=i=>i.map((c,m)=>({text:c==null?void 0:c.description,value:m.toString()}));return v.on("order/data",i=>{const c=String(i.status).toLocaleLowerCase();(c==="guest order cancellation requested"||c==="canceled")&&a()}),N(S,{children:[o(E,{variant:"secondary",onClick:e,"data-testid":"cancel-button",children:o(b,{id:"Order.OrderStatusContent.actions.cancel"})}),t&&o(G,{centered:!0,size:"medium",onClose:a,className:"order-order-cancel__modal",title:o("h2",{className:"order-order-cancel__title",children:o(b,{id:"Order.OrderCancelForm.title"})}),"data-testid":"order-cancellation-reasons-modal",children:o(Y,{orderRef:r,cancelReasons:l(d)})})]})},w={pending:"orderPending",shiping:"orderShipped",complete:"orderComplete",processing:"orderProcessing","on hold":"orderOnHold",canceled:"orderCanceled","suspected fraud":"orderSuspectedFraud","payment Review":"orderPaymentReview","order received":"orderReceived","guest order cancellation requested":"guestOrderCancellationRequested"},ce=({slots:r,title:t,status:n,orderData:e,routeCreateReturn:a,onError:s,routeOnSuccess:d})=>{var M,I,L;const l=!!(e!=null&&e.returnNumber),i=String(n).toLocaleLowerCase(),c=(M=e==null?void 0:e.returns)==null?void 0:M[0],m=(c==null?void 0:c.returnStatus)??"",f=(c==null?void 0:c.createdReturnAt)??"",p=O(`Order.OrderStatusContent.${w[i]}.title`),h=O(`Order.OrderStatusContent.${w[i]}.message`),R=O(`Order.OrderStatusContent.${w[i]}.messageWithoutDate`),u=O({title:`Order.OrderStatusContent.returnStatus.${X(m)}`,returnMessage:"Order.OrderStatusContent.returnMessage"});if(!n)return o("div",{});const C=e!=null&&e.orderStatusChangeDate?h==null?void 0:h.message.replace("{DATE}",e==null?void 0:e.orderStatusChangeDate):R.messageWithoutDate,A=((L=(I=u==null?void 0:u.returnMessage)==null?void 0:I.replace("{ORDER_CREATE_DATE}",x(e==null?void 0:e.orderDate)))==null?void 0:L.replace("{RETURN_CREATE_DATE}",x(f)))??"",T=l?t??u.title:t??p.title;return N(V,{className:"order-order-status-content",variant:"secondary",children:[o(K,{title:T}),N("div",{className:"order-order-status-content__wrapper",children:[o("div",{className:y(["order-order-status-content__wrapper-description",["order-order-status-content__wrapper-description--actions-slot",!!(r!=null&&r.OrderActions)]]),children:o("p",{children:l?A:C})}),o(D,{orderData:e,slots:r,routeCreateReturn:a,routeOnSuccess:d,onError:s})]})]})},oe=({onError:r,routeOnSuccess:t,orderData:n,children:e})=>{const[a,s]=g(!1),d=q(()=>{s(!0);const l=n==null?void 0:n.number;Z(l).then(({success:i,userInputErrors:c})=>{i&&U(t,{}),c.length&&(r==null||r(c))}).catch(i=>{r==null||r(i.message)}).finally(()=>{s(!1)})},[n,t,r]);return o(E,{type:"button",disabled:a,variant:"secondary",className:"order-reorder",onClick:d,children:e})};export{be as OrderStatus,be as default};
